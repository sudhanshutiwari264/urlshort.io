<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple URL Shortener</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: #f5f7fa;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #4f46e5;
      text-align: center;
      margin-bottom: 30px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], input[type="url"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 16px;
    }
    button {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #4338ca;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      background-color: #f3f4f6;
      border-radius: 4px;
    }
    .links-list {
      margin-top: 20px;
    }
    .link-item {
      padding: 15px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      margin-bottom: 10px;
      background-color: #fff;
    }
    .link-short {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .link-long {
      color: #6b7280;
      word-break: break-all;
    }
    .link-actions {
      margin-top: 10px;
    }
    a {
      color: #4f46e5;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom: 2px solid #4f46e5;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .redirect-info {
      text-align: center;
      padding: 30px;
      background-color: #f0f9ff;
      border-radius: 8px;
      margin-top: 20px;
    }
    .countdown {
      font-size: 24px;
      font-weight: bold;
      color: #4f46e5;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Simple URL Shortener</h1>
    
    <div class="tabs">
      <div class="tab active" data-tab="create">Create Short URL</div>
      <div class="tab" data-tab="links">My Links</div>
      <div class="tab" data-tab="redirect">Redirect</div>
    </div>
    
    <div id="create-tab" class="tab-content active">
      <div class="section">
        <h2>Create a Short URL</h2>
        <div class="form-group">
          <label for="long-url">Long URL:</label>
          <input type="url" id="long-url" placeholder="https://example.com/very/long/url/that/needs/shortening">
        </div>
        <div class="form-group">
          <label for="custom-code">Custom Code (optional):</label>
          <input type="text" id="custom-code" placeholder="e.g., my-link">
        </div>
        <button id="create-btn">Create Short URL</button>
        <div id="create-result" class="result" style="display: none;"></div>
      </div>
    </div>
    
    <div id="links-tab" class="tab-content">
      <div class="section">
        <h2>My Links</h2>
        <button id="refresh-btn">Refresh List</button>
        <button id="clear-btn">Clear All Links</button>
        <div id="links-list" class="links-list"></div>
      </div>
    </div>
    
    <div id="redirect-tab" class="tab-content">
      <div class="section">
        <h2>Redirect Tool</h2>
        <div class="form-group">
          <label for="redirect-code">Enter Code to Redirect:</label>
          <input type="text" id="redirect-code" placeholder="Enter the short code">
        </div>
        <button id="redirect-btn">Go to URL</button>
        <div id="redirect-result" class="result" style="display: none;"></div>
      </div>
    </div>
    
    <div id="redirect-container" class="redirect-info" style="display: none;">
      <h2>Redirecting you to:</h2>
      <p id="destination-url"></p>
      <p>You will be redirected in <span id="countdown" class="countdown">3</span> seconds.</p>
      <p>If you are not redirected automatically, <a id="manual-link" href="#">click here</a>.</p>
    </div>
  </div>

  <script>
    // Constants
    const STORAGE_KEY = 'url2025_links';
    
    // DOM Elements
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const longUrlInput = document.getElementById('long-url');
    const customCodeInput = document.getElementById('custom-code');
    const createBtn = document.getElementById('create-btn');
    const createResult = document.getElementById('create-result');
    const refreshBtn = document.getElementById('refresh-btn');
    const clearBtn = document.getElementById('clear-btn');
    const linksList = document.getElementById('links-list');
    const redirectCodeInput = document.getElementById('redirect-code');
    const redirectBtn = document.getElementById('redirect-btn');
    const redirectResult = document.getElementById('redirect-result');
    const redirectContainer = document.getElementById('redirect-container');
    const destinationUrl = document.getElementById('destination-url');
    const countdown = document.getElementById('countdown');
    const manualLink = document.getElementById('manual-link');
    
    // Check if this is a redirect request
    function checkForRedirect() {
      // Get the path from the URL
      const path = window.location.pathname;
      const hash = window.location.hash;
      
      // If there's a hash, it might be our code
      if (hash && hash.startsWith('#')) {
        const code = hash.substring(1);
        console.log('Found code in hash:', code);
        handleRedirect(code);
        return true;
      }
      
      // If the path has segments, the last one might be our code
      if (path !== '/' && path !== '/index.html' && path !== '/simple-redirect.html') {
        const segments = path.split('/');
        const code = segments[segments.length - 1];
        if (code && !code.includes('.')) {
          console.log('Found code in path:', code);
          handleRedirect(code);
          return true;
        }
      }
      
      // Check URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        console.log('Found code in URL parameters:', code);
        handleRedirect(code);
        return true;
      }
      
      return false;
    }
    
    // Handle redirect
    function handleRedirect(code) {
      // Get links from localStorage
      const links = getLinks();
      console.log('Looking for code:', code);
      console.log('Available links:', links);
      
      // Find the link with this code
      let link = links.find(link => link.urlCode === code);
      
      // Try case-insensitive match if not found
      if (!link) {
        link = links.find(link => link.urlCode.toLowerCase() === code.toLowerCase());
      }
      
      if (!link) {
        console.log('No link found for code:', code);
        showTab('redirect');
        redirectResult.style.display = 'block';
        redirectResult.innerHTML = `<p>No link found for code: ${code}</p>`;
        return;
      }
      
      console.log('Found link:', link);
      
      // Update click count
      link.clicks = (link.clicks || 0) + 1;
      link.lastClickedAt = new Date().toISOString();
      
      // Save updated link back to localStorage
      updateLink(link);
      
      // Show redirect info
      showRedirectInfo(link);
    }
    
    // Show redirect info
    function showRedirectInfo(link) {
      // Hide all tabs
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Show redirect container
      redirectContainer.style.display = 'block';
      
      // Set destination URL
      destinationUrl.textContent = link.longUrl;
      manualLink.href = link.longUrl;
      
      // Start countdown
      let count = 3;
      countdown.textContent = count;
      
      const countdownInterval = setInterval(() => {
        count--;
        countdown.textContent = count;
        
        if (count <= 0) {
          clearInterval(countdownInterval);
          window.location.href = link.longUrl;
        }
      }, 1000);
    }
    
    // Tab switching
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        showTab(tabId);
      });
    });
    
    function showTab(tabId) {
      // Update active tab
      tabs.forEach(tab => {
        if (tab.getAttribute('data-tab') === tabId) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });
      
      // Update active content
      tabContents.forEach(content => {
        if (content.id === tabId + '-tab') {
          content.classList.add('active');
        } else {
          content.classList.remove('active');
        }
      });
      
      // Hide redirect container
      redirectContainer.style.display = 'none';
      
      // If showing links tab, refresh the list
      if (tabId === 'links') {
        displayLinks();
      }
    }
    
    // Create short URL
    createBtn.addEventListener('click', () => {
      const longUrl = longUrlInput.value.trim();
      const customCode = customCodeInput.value.trim();
      
      if (!longUrl) {
        showCreateResult('Please enter a long URL', 'error');
        return;
      }
      
      if (!isValidUrl(longUrl)) {
        showCreateResult('Please enter a valid URL', 'error');
        return;
      }
      
      if (customCode && !isValidCode(customCode)) {
        showCreateResult('Custom code can only contain letters, numbers, hyphens, and underscores', 'error');
        return;
      }
      
      createShortUrl(longUrl, customCode);
    });
    
    // Create short URL
    function createShortUrl(longUrl, customCode) {
      // Format URL if needed
      const formattedUrl = formatUrl(longUrl);
      
      // Generate a unique code if no custom code is provided
      const urlCode = customCode || generateUniqueCode();
      
      // Check if code is already taken
      if (isCodeTaken(urlCode)) {
        showCreateResult('This code is already in use. Please choose another one.', 'error');
        return;
      }
      
      // Create the short URL
      const shortUrl = window.location.href.split('#')[0].split('?')[0] + '#' + urlCode;
      
      // Create link object
      const linkObj = {
        id: generateId(),
        urlCode: urlCode,
        longUrl: formattedUrl,
        shortUrl: shortUrl,
        createdAt: new Date().toISOString(),
        clicks: 0,
        lastClickedAt: null
      };
      
      // Save to localStorage
      saveLink(linkObj);
      
      // Show result
      showCreateResult(`
        <p>Your shortened URL is ready!</p>
        <p><a href="${linkObj.shortUrl}" target="_blank">${linkObj.shortUrl}</a></p>
        <button id="copy-btn" onclick="copyToClipboard('${linkObj.shortUrl}')">Copy to Clipboard</button>
      `, 'success');
      
      // Clear inputs
      longUrlInput.value = '';
      customCodeInput.value = '';
    }
    
    // Show create result
    function showCreateResult(message, type) {
      createResult.style.display = 'block';
      createResult.innerHTML = message;
      createResult.className = 'result ' + (type || '');
    }
    
    // Refresh links list
    refreshBtn.addEventListener('click', displayLinks);
    
    // Clear all links
    clearBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to delete all your links?')) {
        localStorage.removeItem(STORAGE_KEY);
        displayLinks();
      }
    });
    
    // Display links
    function displayLinks() {
      const links = getLinks();
      
      if (links.length === 0) {
        linksList.innerHTML = '<p>You have no saved links yet.</p>';
        return;
      }
      
      // Sort links by creation date (newest first)
      links.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      let html = '';
      links.forEach(link => {
        const createdDate = new Date(link.createdAt).toLocaleString();
        const lastClickedDate = link.lastClickedAt ? new Date(link.lastClickedAt).toLocaleString() : 'Never';
        
        html += `
          <div class="link-item">
            <div class="link-short">
              <a href="${link.shortUrl}" target="_blank">${link.shortUrl}</a>
            </div>
            <div class="link-long">${link.longUrl}</div>
            <div class="link-meta">
              Created: ${createdDate} | Clicks: ${link.clicks || 0} | Last clicked: ${lastClickedDate}
            </div>
            <div class="link-actions">
              <button onclick="copyToClipboard('${link.shortUrl}')">Copy</button>
              <button onclick="deleteLink('${link.id}')">Delete</button>
              <button onclick="redirectToUrl('${link.urlCode}')">Test</button>
            </div>
          </div>
        `;
      });
      
      linksList.innerHTML = html;
    }
    
    // Redirect button
    redirectBtn.addEventListener('click', () => {
      const code = redirectCodeInput.value.trim();
      
      if (!code) {
        redirectResult.style.display = 'block';
        redirectResult.innerHTML = '<p>Please enter a code</p>';
        return;
      }
      
      handleRedirect(code);
    });
    
    // Helper functions
    function isValidUrl(url) {
      try {
        new URL(formatUrl(url));
        return true;
      } catch (e) {
        return false;
      }
    }
    
    function formatUrl(url) {
      if (!/^https?:\/\//i.test(url)) {
        return 'https://' + url;
      }
      return url;
    }
    
    function isValidCode(code) {
      return /^[a-zA-Z0-9_-]+$/.test(code);
    }
    
    function isCodeTaken(code) {
      const links = getLinks();
      return links.some(link => link.urlCode.toLowerCase() === code.toLowerCase());
    }
    
    function generateUniqueCode(length = 6) {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code;
      
      do {
        code = '';
        for (let i = 0; i < length; i++) {
          code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
      } while (isCodeTaken(code));
      
      return code;
    }
    
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substring(2);
    }
    
    function getLinks() {
      const linksJson = localStorage.getItem(STORAGE_KEY);
      return linksJson ? JSON.parse(linksJson) : [];
    }
    
    function saveLink(linkObj) {
      const links = getLinks();
      links.push(linkObj);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(links));
    }
    
    function updateLink(linkObj) {
      const links = getLinks();
      const index = links.findIndex(link => link.id === linkObj.id);
      
      if (index !== -1) {
        links[index] = linkObj;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(links));
      }
    }
    
    function deleteLink(id) {
      const links = getLinks();
      const filteredLinks = links.filter(link => link.id !== id);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(filteredLinks));
      displayLinks();
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => alert('Copied to clipboard!'))
        .catch(err => console.error('Could not copy text: ', err));
    }
    
    function redirectToUrl(code) {
      window.location.href = window.location.href.split('#')[0].split('?')[0] + '#' + code;
      location.reload();
    }
    
    // Initialize
    window.onload = function() {
      // Check if this is a redirect request
      if (!checkForRedirect()) {
        // If not, display links
        displayLinks();
      }
    };
  </script>
</body>
</html>